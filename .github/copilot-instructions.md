# Ghost Backup – AI Contributor Notes

- Purpose: CLI and background service that stashes uncommitted work and pushes it to `refs/backups/<user>/<branch>` on the repo’s remote; built with Cobra + kardianos/service and plain git CLI invocations.
- Architecture: `cmd/` holds Cobra commands; `internal/service` wraps kardianos/service and spins a `worker.Manager`; each repo in the registry gets a `worker.Worker` goroutine that ticks on its configured interval and hot-reloads `.ghost-backup.json` when the file mtime changes.
- Config/state locations: global config `~/.config/ghost-backup/config.json` (stores `git_user` + `git_token` used for non-interactive pushes), global registry `~/.config/ghost-backup/registry.json` (list of monitored repos), per-repo config `.ghost-backup.json` (interval, scan_secrets). Logs go to `~/.local/state/ghost-backup/ghost-backup.log` or `$STATE_DIRECTORY` when set.
- User identifier rules: `git.GenerateUserIdentifier` prefers `git_user` (global config) → git username → sanitized email. Refs and branch names are sanitized via `SanitizeRefName`; keep this ordering when adding features that derive identifiers/refs.
- Backup flow (CLI `backup` and worker): check repo validity, skip if no changes, create stash with `git stash create`, optionally run gitleaks (`gitleaks detect --no-git --verbose --redact`, 60s timeout; exit code 1 means secrets and should abort), then push `<hash>:` to `refs/backups/<user>/<branch>` on the chosen remote (prefers `origin`, otherwise first remote). Preserve this sequence and the error handling/early returns when modifying.
- Restore flow: fetch `refs/backups/<user>/<branch>` then either `git stash apply` (`--method apply`) or `git cherry-pick --no-commit` (`--method cherry-pick`). Keep fetch-before-apply and branch-aware ref construction.
- Service behavior: `service.NewService` runs as a user service; `Program.Start` loads global config, calls `git.SetupGitCredentials` to set env vars for non-interactive git, opens the log file, then starts workers based on the registry. Restarting the service is the expected way to pick up registry/config changes from CLI commands.
- Hot reload: workers watch `.ghost-backup.json` mtime and adjust ticker intervals without restart. If you introduce new per-repo settings, ensure reload logic reads them and update the summary logging.
- Secret scanning: keep `security.ScanDiff` contract (timeout, exit code handling, stderr as output); if adding scanners, mirror the same short-circuit semantics so backups abort on findings without altering the worktree.
- CLI patterns: commands live in `cmd/` with `RunE` functions; add new commands in `init()` via `rootCmd.AddCommand(...)`. Prefer absolute paths via `filepath.Abs`, reuse `git.NewGitRepo` + `config.LoadLocalConfig`/`LoadGlobalConfig`, and maintain the user-facing messaging style (✓/⚠ and guidance strings).
- Credential prompts: `config.CheckCredentialsConfigured`/`PromptForMissingCredentials` gate service install/init/check flows; do not bypass them when adding new flows that rely on authenticated pushes.
- Workflow generator: `ghost-backup workflow` writes `.github/workflows/ghost-backup-prune.yml` using `generateWorkflowYAML(cron, retention)`; if adjusting, keep the human-readable cron comment and the delete-from-remote behavior.
- Service management commands: `ghost-backup service {install,start,stop,restart,status,run}` act on the user service; `status` also prints registry contents and log path. Tests use `--skip-service` on `check` to avoid starting real services.
- Build/test/dev: Go 1.24; standard build `go build ./...`; tests are table-driven under `cmd` and `internal`—run `go test ./...`. Nix users can `nix develop` for a fully provisioned shell or `nix run github:FmTod/ghost-backup -- --help` to execute directly.
- Logging: `internal/service` logger writes to the file; workers log high-level actions and errors only. Keep log noise low and include repo paths + hashes where relevant.
- Remotes and branches: `git.GetRemote` prefers `origin` then first remote; avoid introducing logic that assumes a specific remote name. Branch and identifier strings must be sanitized before constructing refs.
- Uninstall/removal: `ghost-backup uninstall` removes repo from registry, deletes `.ghost-backup.json`, then restarts service. Maintain symmetric behavior if adding new registry-manipulating commands.

Questions or unclear areas? Point them out so we can tighten these notes.