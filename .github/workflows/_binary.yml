name: "Reusable Build Binary"

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.25'
      platforms:
        description: 'Platforms to build for (JSON array)'
        required: false
        type: string
        default: '["linux/amd64", "linux/arm64", "windows/amd64", "darwin/amd64", "darwin/arm64"]'
      upload-artifacts:
        description: 'Upload build artifacts'
        required: false
        type: boolean
        default: true
      release-tag:
        description: 'Release tag to upload artifacts to (empty for non-release builds)'
        required: false
        type: string
        default: ''

jobs:
  build:
    name: "Build Binary"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: ${{ fromJSON(inputs.platforms) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ inputs.go-version }}

      - name: Parse platform
        id: platform
        run: |
          platform="${{ matrix.platform }}"
          echo "goos=${platform%/*}" >> $GITHUB_OUTPUT
          echo "goarch=${platform#*/}" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOOS: ${{ steps.platform.outputs.goos }}
          GOARCH: ${{ steps.platform.outputs.goarch }}
        run: |
          mkdir -p dist
          binary_name="ghost-backup-${{ steps.platform.outputs.goos }}-${{ steps.platform.outputs.goarch }}"
          if [ "${{ steps.platform.outputs.goos }}" = "windows" ]; then
            binary_name="${binary_name}.exe"
          fi
          version="${{ inputs.release-tag || 'dev' }}"
          go build -ldflags="-w -s -X github.com/FmTod/ghost-backup/cmd.version=${version}" -o "dist/${binary_name}" .

      - name: Upload artifacts
        if: ${{ inputs.upload-artifacts && inputs.release-tag == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ghost-backup-${{ steps.platform.outputs.goos }}-${{ steps.platform.outputs.goarch }}
          path: dist/ghost-backup-${{ steps.platform.outputs.goos }}-${{ steps.platform.outputs.goarch }}*

      - name: Upload to Release
        if: ${{ inputs.release-tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release-tag }}
          files: dist/ghost-backup-${{ steps.platform.outputs.goos }}-${{ steps.platform.outputs.goarch }}*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
